// =============================================
// TRANSLATIONS (unchanged)
// =============================================
const translations = {
    en: {
        title: "MediCare - Your Trusted Pharmacy",
        select_pincode: "Select Pincode",
        change: "Change",
        login: "Login",
        wishlist: "Wishlist",
        cart: "Cart",
        menu: "Menu",
        medicine_healthcare: "Medicine & Healthcare",
        prescription_medicines: "Prescription Medicines (Upload Prescription)",
        otc_medicines: "Over-the-Counter (OTC) Medicines",
        chronic_care: "Chronic Care (Diabetes, Hypertension, Cardiac, Asthma, Thyroid)",
        first_aid: "First Aid & Emergency",
        pain_relief: "Pain Relief & Fever",
        allergy_cold: "Allergy & Cold Care",
        digestive_health: "Digestive Health",
        mother_care: "Mother Care",
        maternity_wear: "Maternity Wear",
        pregnancy_nutrition: "Pregnancy Nutrition",
        skincare_moms: "Skincare for Moms",
        trimester_kits: "Trimester Kits",
        postpartum_recovery: "Postpartum Recovery",
        breastfeeding_essentials: "Breastfeeding Essentials",
        baby_care: "Baby Care",
        diapers_wipes: "Diapers & Wipes",
        baby_skincare: "Baby Skin & Hair Care",
        feeding_nursing: "Feeding & Nursing",
        baby_health_safety: "Baby Health & Safety",
        toys_learning: "Toys & Learning",
        baby_clothing: "Baby Clothing & Accessories",
        wellness: "Wellness",
        vitamins_supplements: "Vitamins & Supplements",
        skin_hair_care: "Skin & Hair Care",
        oral_care: "Oral Care",
        menstrual_care: "Menstrual & Intimate Care",
        fitness_weight: "Fitness & Weight Management",
        devices: "Devices",
        monitoring_devices: "Monitoring Devices (BP Monitors, Glucometers)",
        mobility_aids: "Mobility Aids (Walkers, Wheelchairs)",
        respiratory_care: "Respiratory Care (Nebulizers, Oxygen)",
        speciality_care: "Speciality Care",
        womens_health: "Women's Health",
        mens_health: "Men's Health",
        senior_care: "Senior Care",
        immunity_boosters: "Immunity Boosters",
        ayurveda_herbal: "Ayurveda & Herbal Products",
        enter_pincode: "Enter Your Pincode",
        invalid_pincode: "Please enter a valid 6-digit Indian pincode.",
        submit: "Submit",
        select_language: "Select Language",
        english: "English",
        hindi: "Hindi",
        marathi: "Marathi",
        welcome: "Welcome",
        signup: "Sign Up",
        phone: "Phone Number",
        password: "Password",
        remember_me: "Remember me",
        forgot_password: "Forgot password?",
        google: "Google",
        facebook: "Facebook",
        first_name: "First Name",
        last_name: "Last Name",
        email: "Email",
        confirm_password: "Confirm Password",
        address_landmark: "Landmark",
        address_area: "Area",
        address_city: "City",
        address_pincode: "Pincode",
        address_state: "State",
        address_country: "Country",
        address_type: "Address Type (Home/Office)",
        accept_terms: "I accept the Terms & Conditions",
        new_customer: "New customer?",
        existing_customer: "Already a user? Login",
        close: "Close",
        reset_password: "Reset Password",
        send_reset_link: "Send Reset Link",
        my_orders: "My Orders",
        my_profile: "My Profile",
        contact: "Contact",
        About: "About",
        confirm_logout: "Confirm Logout",
        logout_message: "Are you sure you want to log out?"
    },
    hi: {
        title: "मेडिकेयर - आपकी विश्वसनीय फार्मेसी",
        select_pincode: "पिनकोड चुनें",
        change: "बदलें",
        login: "लॉगिन",
        wishlist: "इच्छा सूची",
        cart: "कार्ट",
        menu: "मेनू",
        medicine_healthcare: "दवाएँ और स्वास्थ्य देखभाल",
        prescription_medicines: "प्रिस्क्रिप्शन दवाएँ (प्रिस्क्रिप्शन अपलोड करें)",
        otc_medicines: "ओवर-द-काउंटर (OTC) दवाएँ",
        chronic_care: "क्रोनिक केयर (मधुमेह, उच्च रक्तचाप, हृदय, अस्थमा, थायरॉयड)",
        first_aid: "प्राथमिक चिकित्सा और आपातकाल",
        pain_relief: "दर्द निवारण और बुखार",
        allergy_cold: "एलर्जी और सर्दी देखभाल",
        digestive_health: "पाचन स्वास्थ्य",
        mother_care: "मातृ देखभाल",
        maternity_wear: "मातृत्व वस्त्र",
        pregnancy_nutrition: "गर्भावस्था पोषण",
        skincare_moms: "माताओं के लिए त्वचा देखभाल",
        trimester_kits: "ट्राइमेस्टर किट",
        postpartum_recovery: "प्रसवोत्तर रिकवरी",
        breastfeeding_essentials: "स्तनपान आवश्यकताएँ",
        baby_care: "शिशु देखभाल",
        diapers_wipes: "डायपर और वाइप्स",
        baby_skincare: "शिशु त्वचा और बाल देखभाल",
        feeding_nursing: "खिलाना और नर्सिंग",
        baby_health_safety: "शिशु स्वास्थ्य और सुरक्षा",
        toys_learning: "खिलौने और सीखना",
        baby_clothing: "शिशु वस्त्र और सहायक उपकरण",
        wellness: "वेलनेस",
        vitamins_supplements: "विटामिन और पूरक",
        skin_hair_care: "त्वचा और बाल देखभाल",
        oral_care: "मौखिक देखभाल",
        menstrual_care: "मासिक और अंतरंग देखभाल",
        fitness_weight: "फिटनेस और वजन प्रबंधन",
        devices: "उपकरण",
        monitoring_devices: "निगरानी उपकरण (बीपी मॉनिटर, ग्लूकोमीटर)",
        mobility_aids: "गतिशीलता सहायता (वॉकर, व्हीलचेयर)",
        respiratory_care: "श्वसन देखभाल (नेबुलाइज़र, ऑक्सीजन)",
        speciality_care: "विशेष देखभाल",
        womens_health: "महिला स्वास्थ्य",
        mens_health: "पुरुष स्वास्थ्य",
        senior_care: "वरिष्ठ देखभाल",
        immunity_boosters: "प्रतिरक्षा बढ़ाने वाले",
        ayurveda_herbal: "आयुर्वेद और हर्बल उत्पाद",
        enter_pincode: "अपना पिनकोड दर्ज करें",
        invalid_pincode: "कृपया वैध 6-अंकीय भारतीय पिनकोड दर्ज करें।",
        submit: "जमा करें",
        select_language: "भाषा चुनें",
        english: "अंग्रेजी",
        hindi: "हिंदी",
        marathi: "मराठी",
        welcome: "आपका स्वागत है",
        signup: "साइन अप",
        phone: "फ़ोन नंबर",
        password: "पासवर्ड",
        remember_me: "मुझे याद रखें",
        forgot_password: "पासवर्ड भूल गए?",
        google: "गूगल",
        facebook: "फेसबुक",
        first_name: "प्रथम नाम",
        last_name: "अंतिम नाम",
        email: "ईमेल",
        confirm_password: "पासवर्ड की पुष्टि करें",
        address_landmark: "लैंडमार्क",
        address_area: "क्षेत्र",
        address_city: "शहर",
        address_pincode: "पिनकोड",
        address_state: "राज्य",
        address_country: "देश",
        address_type: "पता प्रकार (घर/कार्यालय)",
        accept_terms: "मैं नियम और शर्तें स्वीकार करता हूं",
        new_customer: "नए ग्राहक?",
        existing_customer: "पहले से उपयोगकर्ता? लॉगिन",
        close: "बंद करें",
        reset_password: "पासवर्ड रीसेट करें",
        send_reset_link: "रीसेट लिंक भेजें",
        confirm_logout: "लॉगआउट की पुष्टि करें",
        logout_message: "क्या आप वाकई लॉगआउट करना चाहते हैं?"
    },
    mr: {
        title: "मेडिकेअर - तुमचा विश्वासू फार्मसी",
        select_pincode: "पिनकोड निवडा",
        change: "बदला",
        login: "लॉगिन",
        wishlist: "इच्छा यादी",
        cart: "कार्ट",
        menu: "मेनू",
        medicine_healthcare: "औषधे आणि आरोग्य सेवा",
        prescription_medicines: "प्रिस्क्रिप्शन औषधे (प्रिस्क्रिप्शन अपलोड करा)",
        otc_medicines: "ओव्हर-द-काउंटर (OTC) औषधे",
        chronic_care: "क्रॉनिक केअर (मधुमेह, उच्च रक्तदाब, हृदय, दमा, थायरॉईड)",
        first_aid: "प्रथमोपचार आणि आपत्कालीन",
        pain_relief: "वेदना निवारण आणि ताप",
        allergy_cold: "ऍलर्जी आणि सर्दीची काळजी",
        digestive_health: "पचन आरोग्य",
        mother_care: "माता काळजी",
        maternity_wear: "मातृत्व परिधान",
        pregnancy_nutrition: "गर्भधारणा पोषण",
        skincare_moms: "मातांसाठी त्वचा काळजी",
        trimester_kits: "ट्रायमेस्टर किट",
        postpartum_recovery: "प्रसवोत्तर पुनर्प्राप्ती",
        breastfeeding_essentials: "स्तनपान आवश्यक गोष्टी",
        baby_care: "बाळाची काळजी",
        diapers_wipes: "डायपर आणि वाइप्स",
        baby_skincare: "बाळाची त्वचा आणि केसांची काळजी",
        feeding_nursing: "खाणे आणि नर्सिंग",
        baby_health_safety: "बाळाचे आरोग्य आणि सुरक्षा",
        toys_learning: "खेळणी आणि शिक्षण",
        baby_clothing: "बाळाचे कपडे आणि उपकरणे",
        wellness: "वेलनेस",
        vitamins_supplements: "व्हिटॅमिन आणि पूरक",
        skin_hair_care: "त्वचा आणि केसांची काळजी",
        oral_care: "तोंडी काळजी",
        menstrual_care: "मासिक आणि अंतरंग काळजी",
        fitness_weight: "फिटनेस आणि वजन व्यवस्थापन",
        devices: "उपकरणे",
        monitoring_devices: "निगरानी उपकरणे (बीपी मॉनिटर, ग्लूकोमीटर)",
        mobility_aids: "गतिशीलता सहाय्य (वॉकर, व्हीलचेयर)",
        respiratory_care: "श्वसन काळजी (नेबुलायझर, ऑक्सिजन)",
        speciality_care: "विशेष काळजी",
        womens_health: "महिलांचे आरोग्य",
        mens_health: "पुरुषांचे आरोग्य",
        senior_care: "वरिष्ठ काळजी",
        immunity_boosters: "रोगप्रतिकारक शक्ती वाढवणारे",
        ayurveda_herbal: "आयुर्वेद आणि हर्बल उत्पादने",
        enter_pincode: "तुमचा पिनकोड टाका",
        invalid_pincode: "कृपया वैध 6-अंकी भारतीय पिनकोड टाका.",
        submit: "सबमिट करा",
        select_language: "भाषा निवडा",
        english: "इंग्रजी",
        hindi: "हिंदी",
        marathi: "मराठी",
        welcome: "स्वागत आहे",
        signup: "साइन अप",
        phone: "फोन क्रमांक",
        password: "पासवर्ड",
        remember_me: "मला लक्षात ठेवा",
        forgot_password: "पासवर्ड विसरलात?",
        google: "गूगल",
        facebook: "फेसबुक",
        first_name: "पहिले नाव",
        last_name: "शेवटचे नाव",
        email: "ईमेल",
        confirm_password: "पासवर्डची पुष्टी करा",
        address_landmark: "लँडमार्क",
        address_area: "क्षेत्र",
        address_city: "शहर",
        address_pincode: "पिनकोड",
        address_state: "राज्य",
        address_country: "देश",
        address_type: "पत्ता प्रकार (घर/कार्यालय)",
        accept_terms: "मी अटी व नियमांशी सहमत आहे",
        new_customer: "नवीन ग्राहक?",
        existing_customer: "आधीच वापरकर्ता? लॉगिन",
        close: "बंद करा",
        reset_password: "पासवर्ड रीसेट करा",
        send_reset_link: "रीसेट लिंक पाठवा",
        confirm_logout: "लॉगआउट निश्चित करा",
        logout_message: "तुम्हाला खरंच लॉगआउट करायचं आहे का?"
    }
};

// =============================================
// API CONFIGURATION & HELPER FUNCTIONS
// =============================================
const API_BASE_URL = 'http://localhost:8083/api/users';
async function apiRequest(endpoint, method = 'GET', data = null) {
    const options = {
        method,
        headers: {
            'Content-Type': 'application/json',
        }
    };
    if (data) {
        options.body = JSON.stringify(data);
    }
    try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
       
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `HTTP error! status: ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        console.error('API request failed:', error);
        throw error;
    }
}

// Updated login function to use your backend endpoint
// =============================================
// UPDATED LOGIN FUNCTION - Use the proper backend login endpoint
// =============================================
async function loginUser(phone, password) {
    try {
        console.log('Attempting login with:', { phone, password });
        
        // Use the correct login endpoint that matches your backend
        const response = await fetch(`${API_BASE_URL}/login?mobile=${phone}&password=${password}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        console.log('Login response status:', response.status);
        
        if (!response.ok) {
            // If response is not OK, try to get error message
            let errorMessage = 'Login failed';
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
            } catch (e) {
                // If we can't parse JSON, use status text
                errorMessage = response.statusText || errorMessage;
            }
            throw new Error(errorMessage);
        }

        const user = await response.json();
        console.log('Login successful, user:', user);
        
        // Store user session
        const loginData = {
            user: user,
            loginTime: Date.now()
        };
        
        try {
            sessionStorage.setItem('loggedInUser', JSON.stringify(loginData));
            sessionStorage.setItem('userId', user.userId);
        } catch (e) {
            console.warn('Session storage unavailable');
        }
        
        return { success: true, user };
        
    } catch (error) {
        console.error('Login error:', error);
        return { success: false, message: error.message || 'Login failed. Please try again.' };
    }
}

// Keep all your existing API functions the same
async function createUserAPI(userData) {
    return await apiRequest('/create-user', 'POST', userData);
}

async function getAllUsersAPI() {
    return await apiRequest('/get-all-users', 'GET');
}
// API Functions
async function createUserAPI(userData) {
    return await apiRequest('/create-user', 'POST', userData);
}
async function getAllUsersAPI() {
    return await apiRequest('/get-all-users', 'GET');
}
// Login function with 24-hour session
// async function loginUser(phone, password) {
//     try {
//         const allUsers = await getAllUsersAPI();
//         const user = allUsers.find(u => u.phone === phone && u.password === password);
       
//         if (user) {
//             const loginData = {
//                 user: user,
//                 loginTime: Date.now()
//             };
//             try {
//                 sessionStorage.setItem('loggedInUser', JSON.stringify(loginData));
//                 sessionStorage.setItem('userId', user.userId);
//             } catch (e) {
//                 console.warn('Session storage unavailable');
//             }
//             return { success: true, user };
//         } else {
//             return { success: false, message: 'Invalid phone number or password' };
//         }
//     } catch (error) {
//         console.error('Login error:', error);
//         return { success: false, message: 'Login failed. Please try again.' };
//     }
// }

// =============================================
// SESSION & LOGOUT HELPERS
// =============================================
function isSessionValid() {
    try {
        const data = sessionStorage.getItem('loggedInUser');
        if (!data) return false;
        const { loginTime } = JSON.parse(data);
        const hoursElapsed = (Date.now() - loginTime) / (1000 * 60 * 60);
        return hoursElapsed < 24;
    } catch (e) {
        return false;
    }
}

function clearSession() {
    try {
        sessionStorage.removeItem('loggedInUser');
        sessionStorage.removeItem('userId');
    } catch (e) {
        console.warn('Failed to clear session');
    }
}

function showLogoutConfirm() {
    const overlay = document.getElementById('logoutConfirmOverlay');
    if (overlay) overlay.classList.add('show');
}

function hideLogoutConfirm() {
    const overlay = document.getElementById('logoutConfirmOverlay');
    if (overlay) overlay.classList.remove('show');
}

// =============================================
// UI UPDATE: Login → Logout
// =============================================
function updateLoginTrigger(user) {
    const trigger = document.getElementById('loginTrigger');
    if (!trigger) return;

    if (user) {
        trigger.innerHTML = `
            <i class="fas fa-user-circle"></i>
            <span class="hidden md:inline ml-1">Logout</span>
        `;
        trigger.onclick = (e) => {
            e.preventDefault();
            showLogoutConfirm();
        };
    } else {
        trigger.innerHTML = `
            <i class="fas fa-user-circle"></i>
            <span class="hidden md:inline ml-1" data-i18n="login">Login</span>
        `;
        trigger.onclick = (e) => {
            e.preventDefault();
            const slider = document.getElementById('auth-slider');
            const overlay = document.getElementById('auth-overlay');
            if (slider && overlay) {
                slider.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        };
    }
    applyLanguage(localStorage.getItem('language') || 'en');
}

// =============================================
// INITIALIZATION FUNCTIONS
// =============================================
function initializePage() {
    console.log('Initializing page');
    let savedLanguage;
    try {
        savedLanguage = localStorage.getItem('language') || 'en';
    } catch (e) {
        console.warn('localStorage unavailable, using default language: en');
        savedLanguage = 'en';
    }
    document.documentElement.lang = savedLanguage;
    const currentLanguageElement = document.getElementById('currentLanguage');
    if (currentLanguageElement) {
        currentLanguageElement.textContent = savedLanguage.toUpperCase();
    } else {
        console.warn('currentLanguage element not found');
    }
    applyLanguage(savedLanguage);
   
    let savedPincode;
    try {
        savedPincode = localStorage.getItem('pincode');
    } catch (e) {
        console.warn('localStorage unavailable for pincode');
        savedPincode = null;
    }
  
    const locationDisplay = document.getElementById('locationDisplay');
    const deliveryInfo = document.getElementById('deliveryInfo');
    const deliveryMessage = document.getElementById('deliveryMessage');
    if (savedPincode && locationDisplay && deliveryInfo && deliveryMessage) {
        locationDisplay.textContent = savedPincode;
        const estimatedDays = savedPincode.startsWith('1') || savedPincode.startsWith('2') ? '2-3 days' : '3-5 days';
        deliveryInfo.classList.remove('hidden');
        deliveryMessage.textContent = estimatedDays;
        deliveryMessage.classList.add('text-green-600');
    } else {
        showLocationModal();
    }
   
    initAuthSlider();
    initLanguageSelection();
    initMobileMenu();
    initLocationModal();
    initPasswordToggles();
   
    const languageButton = document.getElementById('languageButton');
    if (languageButton) {
        languageButton.addEventListener('click', () => {
            console.log('Language button clicked');
            showLanguageModal();
        });
    } else {
        console.warn('languageButton not found');
    }
   
    const changeLocation = document.getElementById('changeLocation');
    if (changeLocation) {
        changeLocation.addEventListener('click', (e) => {
            e.preventDefault();
            showLocationModal();
        });
    } else {
        console.warn('changeLocation button not found');
    }

    // Check session
    if (isSessionValid()) {
        const data = JSON.parse(sessionStorage.getItem('loggedInUser'));
        updateLoginTrigger(data.user);
    } else {
        clearSession();
        updateLoginTrigger(null);
    }

    // Logout confirmation handlers (FIXED: addEventListener + removed duplicate)
    document.getElementById('cancelLogout')?.addEventListener('click', hideLogoutConfirm);
    document.getElementById('confirmLogout')?.addEventListener('click', () => {
        clearSession();
        hideLogoutConfirm();
        updateLoginTrigger(null);
        alert('You have been logged out.');
    });
}

// =============================================
// LOCATION MODAL FUNCTIONS
// =============================================
function showLocationModal() {
    const locationModal = document.getElementById('locationModal');
    if (locationModal) {
        locationModal.classList.remove('hidden');
        locationModal.style.display = 'flex';
        const pincodeInput = document.getElementById('pincodeInput');
        if (pincodeInput) pincodeInput.focus();
        console.log('Location modal displayed');
    } else {
        console.error('locationModal not found in DOM');
    }
}
function closeLocationModal() {
    const locationModal = document.getElementById('locationModal');
    if (locationModal) {
        locationModal.classList.add('hidden');
        locationModal.style.display = 'none';
        const pincodeError = document.getElementById('pincodeError');
        const pincodeInput = document.getElementById('pincodeInput');
        if (pincodeError) pincodeError.classList.add('hidden');
        if (pincodeInput) pincodeInput.value = '';
        console.log('Location modal closed');
    } else {
        console.error('locationModal not found in DOM');
    }
}
function validatePincode() {
    const pincodeInput = document.getElementById('pincodeInput');
    const pincodeError = document.getElementById('pincodeError');
    const locationModal = document.getElementById('locationModal');
    const deliveryInfo = document.getElementById('deliveryInfo');
    const deliveryMessage = document.getElementById('deliveryMessage');
    const locationDisplay = document.getElementById('locationDisplay');
  
    let currentLang;
    try {
        currentLang = localStorage.getItem('language') || 'en';
    } catch (e) {
        currentLang = 'en';
    }
  
    const pincodePattern = /^[1-9][0-9]{5}$/;
    if (!pincodeInput || !pincodeInput.value.trim()) {
        if (pincodeError) {
            pincodeError.textContent = translations[currentLang]['invalid_pincode'];
            pincodeError.classList.remove('auth-hidden');
        }
        console.warn('Pincode input empty');
    } else if (pincodePattern.test(pincodeInput.value.trim())) {
        const pincode = pincodeInput.value.trim();
        if (pincodeError) pincodeError.classList.add('hidden');
      
        try {
            localStorage.setItem('pincode', pincode);
        } catch (e) {
            console.warn('Cannot save to localStorage');
        }
      
        if (locationModal) {
            locationModal.classList.add('hidden');
            locationModal.style.display = 'none';
        }
        if (locationDisplay) {
            locationDisplay.textContent = pincode;
        }
        const estimatedDays = pincode.startsWith('1') || pincode.startsWith('2') ? '2-3 days' : '3-5 days';
        if (deliveryInfo && deliveryMessage) {
            deliveryInfo.classList.remove('hidden');
            deliveryMessage.textContent = estimatedDays;
            deliveryMessage.classList.add('text-green-600');
        }
        console.log('Pincode validated:', pincode);
    } else {
        if (pincodeError) {
            pincodeError.textContent = translations[currentLang]['invalid_pincode'];
            pincodeError.classList.remove('hidden');
        }
        console.warn('Invalid pincode:', pincodeInput.value);
    }
}
function initLocationModal() {
    const validatePincodeBtn = document.getElementById('validatePincode');
    const closeLocationModalBtn = document.getElementById('closeLocationModal');
    const pincodeInput = document.getElementById('pincodeInput');
   
    if (validatePincodeBtn) {
        validatePincodeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Validate pincode button clicked');
            validatePincode();
        });
    } else {
        console.warn('validatePincode button not found');
    }
   
    if (closeLocationModalBtn) {
        closeLocationModalBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Close location modal button clicked');
            closeLocationModal();
        });
    } else {
        console.warn('closeLocationModal button not found');
    }
   
    if (pincodeInput) {
        pincodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                validatePincode();
            }
        });
    } else {
        console.warn('pincodeInput not found');
    }
}

// =============================================
// LANGUAGE MODAL FUNCTIONS
// =============================================
function showLanguageModal() {
    const languageModal = document.getElementById('languageModal');
    if (languageModal) {
        languageModal.classList.remove('hidden');
        languageModal.style.display = 'flex';
        console.log('Language modal displayed');
    } else {
        console.error('languageModal not found in DOM');
    }
}
function closeLanguageModal() {
    const languageModal = document.getElementById('languageModal');
    if (languageModal) {
        languageModal.classList.add('hidden');
        languageModal.style.display = 'none';
        console.log('Language modal closed');
    } else {
        console.error('languageModal not found in DOM');
    }
}
function selectLanguage(language) {
    const langCode = language === 'English' ? 'en' : language === 'Hindi' ? 'hi' : 'mr';
    console.log('Selected language:', language, 'langCode:', langCode);
    try {
        localStorage.setItem('language', langCode);
    } catch (e) {
        console.warn('Cannot save language to localStorage');
    }
    document.documentElement.lang = langCode;
    const currentLanguageElement = document.getElementById('currentLanguage');
    if (currentLanguageElement) {
        currentLanguageElement.textContent = langCode.toUpperCase();
    }
    applyLanguage(langCode);
    closeLanguageModal();
}
function initLanguageSelection() {
    const languageButtons = document.querySelectorAll('.language-btn');
    console.log('Language buttons found:', languageButtons.length);
    languageButtons.forEach(button => {
        const lang = button.getAttribute('data-lang');
        button.addEventListener('click', () => {
            console.log('Language button clicked:', lang);
            selectLanguage(lang);
        });
    });
   
    const closeLanguageModalBtn = document.getElementById('closeLanguageModal');
    if (closeLanguageModalBtn) {
        closeLanguageModalBtn.addEventListener('click', closeLanguageModal);
        console.log('Close language modal button initialized');
    } else {
        console.warn('closeLanguageModal button not found');
    }
}

// =============================================
// FORGOT PASSWORD MODAL FUNCTIONS
// =============================================
function showForgetPasswordModal() {
    const forgetModal = document.getElementById('forgetPasswordModal');
    if (forgetModal) {
        forgetModal.classList.remove('hidden');
        forgetModal.style.display = 'flex';
        const forgetEmailInput = document.getElementById('forgetEmail');
        if (forgetEmailInput) forgetEmailInput.focus();
        console.log('Forget password modal displayed');
    } else {
        console.error('forgetPasswordModal not found in DOM');
    }
}
function closeForgetPasswordModal() {
    const forgetModal = document.getElementById('forgetPasswordModal');
    if (forgetModal) {
        forgetModal.classList.add('hidden');
        forgetModal.style.display = 'none';
        const forgetEmailInput = document.getElementById('forgetEmail');
        if (forgetEmailInput) forgetEmailInput.value = '';
        console.log('Forget password modal closed');
    } else {
        console.warn('forgetPasswordModal not found in DOM');
    }
}

// =============================================
// MOBILE MENU FUNCTIONS
// =============================================
function initMobileMenu() {
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const closeMobileMenu = document.getElementById('closeMobileMenu');
   
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', () => {
            mobileMenu.classList.add('mobile-open');
            mobileMenuOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            console.log('Mobile menu opened');
        });
    } else {
        console.warn('mobileMenuToggle not found');
    }
   
    if (closeMobileMenu) {
        closeMobileMenu.addEventListener('click', () => {
            mobileMenu.classList.remove('mobile-open');
            mobileMenuOverlay.classList.add('hidden');
            document.body.style.overflow = 'auto';
            console.log('Mobile menu closed');
        });
    } else {
        console.warn('closeMobileMenu not found');
    }
   
    if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', () => {
            mobileMenu.classList.remove('mobile-open');
            mobileMenuOverlay.classList.add('hidden');
            document.body.style.overflow = 'auto';
            console.log('Mobile menu closed via overlay');
        });
    }
}

// =============================================
// PASSWORD TOGGLE FUNCTIONS
// =============================================
function initPasswordToggles() {
    // Login form password toggle
    const loginPasswordToggle = document.querySelector('#login-form .relative button');
    if (loginPasswordToggle) {
        loginPasswordToggle.addEventListener('click', function() {
            const passwordInput = document.getElementById('loginPassword');
            const icon = this.querySelector('i');
            togglePasswordVisibility(passwordInput, icon);
        });
    }

    // Signup form password toggle
    const signupPasswordInput = document.getElementById('signupPassword');
    if (signupPasswordInput) {
        const signupPasswordToggle = signupPasswordInput.parentElement.querySelector('button');
        if (signupPasswordToggle) {
            signupPasswordToggle.addEventListener('click', function() {
                const icon = this.querySelector('i');
                togglePasswordVisibility(signupPasswordInput, icon);
            });
        }
    }
   
   const confirmPasswordInput = document.getElementById('signupConfirmPassword');
    if (confirmPasswordInput) {
        const confirmPasswordToggle = confirmPasswordInput.parentElement.querySelector('button');
        if (confirmPasswordToggle) {
            confirmPasswordToggle.addEventListener('click', function() {
                const icon = this.querySelector('i');
                togglePasswordVisibility(confirmPasswordInput, icon);
            });
        }
    }

        const forgetEmailInput = document.getElementById('forgetEmail');
    if (forgetEmailInput && forgetEmailInput.parentElement.querySelector('button')) {
        const forgetEmailToggle = forgetEmailInput.parentElement.querySelector('button');
        if (forgetEmailToggle) {
            forgetEmailToggle.addEventListener('click', function() {
                const icon = this.querySelector('i');
                // Assuming you want to toggle email visibility (though unusual)
                // You might want to remove this if not needed for email
            });
        }
    }
}
function togglePasswordVisibility(passwordInput, icon) {
    if (!passwordInput || !icon) return;
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// =============================================
// AUTH SLIDER (LOGIN/SIGNUP) FUNCTIONS
// =============================================
function initAuthSlider() {
    console.log('Initializing auth slider');
    const authSlider = document.getElementById('auth-slider');
    const authOverlay = document.getElementById('auth-overlay');
    const closeAuth = document.getElementById('close-auth');
    const loginTab = document.getElementById('login-tab');
    const signupTab = document.getElementById('signup-tab');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const switchToSignup = document.getElementById('switch-to-signup');
    const switchToLogin = document.getElementById('switch-to-login');
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    const sendResetLink = document.getElementById('sendResetLink');
    const closeForgetModal = document.getElementById('closeForgetModal');
   
    if (!authSlider || !authOverlay) {
        console.warn('Auth slider or overlay not found in the DOM');
        return;
    }
    initPasswordToggles();
    if (document.getElementById('loginTrigger')) {
        document.getElementById('loginTrigger').addEventListener('click', function(e) {
            e.preventDefault();
            authSlider.classList.add('active');
            authOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('Login slider opened');
        });
    }
    if (closeAuth) {
        closeAuth.addEventListener('click', function() {
            authSlider.classList.remove('active');
            authOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
            console.log('Auth slider closed');
        });
    }
    if (authOverlay) {
        authOverlay.addEventListener('click', function(e) {
            if (e.target === authOverlay) {
                authSlider.classList.remove('active');
                authOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
                console.log('Auth slider closed via overlay');
            }
        });
    }
    if (loginTab && signupTab && loginForm && signupForm) {
        loginTab.addEventListener('click', function() {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            console.log('Switched to login tab');
        });
       
        signupTab.addEventListener('click', function() {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            console.log('Switched to signup tab');
        });
    }
    if (switchToSignup) {
        switchToSignup.addEventListener('click', function(e) {
            e.preventDefault();
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            console.log('Switched to signup via link');
        });
    }
    if (switchToLogin) {
        switchToLogin.addEventListener('click', function(e) {
            e.preventDefault();
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            console.log('Switched to login via link');
        });
    }
    if (forgotPasswordLink) {
        forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            authSlider.classList.remove('active');
            authOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
            showForgetPasswordModal();
            console.log('Forgot password link clicked');
        });
    }
    if (sendResetLink) {
        sendResetLink.addEventListener('click', function(e) {
            e.preventDefault();
            const forgetEmail = document.getElementById('forgetEmail');
            if (forgetEmail && forgetEmail.value.trim()) {
                console.log('Sending reset link to:', forgetEmail.value.trim());
                alert('Reset link sent to ' + forgetEmail.value.trim());
                closeForgetPasswordModal();
            } else {
                console.warn('Email input empty or not found');
                alert('Please enter a valid email');
            }
        });
    }
    if (closeForgetModal) {
        closeForgetModal.addEventListener('click', closeForgetPasswordModal);
        console.log('Forget password modal close button initialized');
    }

    // =============================================
    // SIGNUP WITH BACKEND API INTEGRATION
    // =============================================
    const signupButton = document.querySelector('#signup-form .auth-btn');
    if (signupButton) {
        signupButton.addEventListener('click', async function(e) {
            e.preventDefault();
            document.querySelectorAll('#signup-form small').forEach(el => el.classList.add('hidden'));
            let valid = true;
            let currentLang = 'en';
            try {
                currentLang = localStorage.getItem('language') || 'en';
            } catch (e) {}
            const t = translations[currentLang];
            const firstName = document.getElementById('signupFirstName')?.value.trim();
            const lastName = document.getElementById('signupLastName')?.value.trim();
            const email = document.getElementById('signupEmail')?.value.trim();
            const phone = document.getElementById('signupPhone')?.value.trim();
            const password = document.getElementById('signupPassword')?.value;
            const confirmPassword = document.getElementById('signupConfirmPassword')?.value;
            const addressLandmark = document.getElementById('addressLandmark')?.value.trim();
            const addressArea = document.getElementById('addressArea')?.value.trim();
            const addressCity = document.getElementById('addressCity')?.value.trim();
            const addressPincode = document.getElementById('addressPincode')?.value.trim();
            const addressState = document.getElementById('addressState')?.value.trim() || 'Maharashtra';
            const addressCountry = document.getElementById('addressCountry')?.value.trim() || 'India';
            const addressType = document.getElementById('addressType')?.value;
            const acceptTerms = document.getElementById('acceptTerms')?.checked;
            const phonePattern = /^[6-9]\d{9}$/;
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const pincodePattern = /^[1-9][0-9]{5}$/;
            if (!firstName) { showError('firstNameError', t['first_name'] + ' is required'); valid = false; }
            if (!lastName) { showError('lastNameError', t['last_name'] + ' is required'); valid = false; }
            if (!email || !emailPattern.test(email)) { showError('emailError', 'Enter a valid email'); valid = false; }
            if (!phone || !phonePattern.test(phone)) { showError('phoneError', 'Enter a valid 10-digit Indian phone number'); valid = false; }
            if (!password || password.length < 6) { showError('passwordError', 'Password must be at least 6 characters'); valid = false; }
            if (password !== confirmPassword) { showError('confirmPasswordError', 'Passwords do not match'); valid = false; }
            if (!addressLandmark) { showError('landmarkError', 'Landmark is required'); valid = false; }
            if (!addressArea) { showError('areaError', 'Area is required'); valid = false; }
            if (!addressCity) { showError('cityError', 'City is required'); valid = false; }
            if (!addressPincode || !pincodePattern.test(addressPincode)) { showError('pincodeSignupError', t['invalid_pincode']); valid = false; }
            if (!addressType) { showError('addressTypeError', 'Please select address type'); valid = false; }
            if (!acceptTerms) { showError('termsError', 'You must accept the terms'); valid = false; }
            if (valid) {
                const userData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: phone,
                    password: password,
                    addressLandmark: addressLandmark,
                    addressArea: addressArea,
                    addressCity: addressCity,
                    addressPincode: addressPincode,
                    addressState: addressState,
                    addressCountry: addressCountry,
                    addressType: addressType
                };
                try {
                    signupButton.disabled = true;
                    signupButton.textContent = 'Creating Account...';
                    const response = await createUserAPI(userData);
                   
                    console.log('User created successfully:', response);
                    alert(`Account created successfully for ${firstName} ${lastName}!\nUser ID: ${response.userId}`);
                   
                    // FIXED: Safe form reset + close slider
                    const form = document.getElementById('signup-form');
                    if (form && typeof form.reset === 'function') form.reset();
                    if (closeAuth) closeAuth.click();

                    const loginData = { user: response, loginTime: Date.now() };
                    sessionStorage.setItem('loggedInUser', JSON.stringify(loginData));
                    sessionStorage.setItem('userId', response.userId);
                    updateLoginTrigger(response);
                } catch (error) {
                    console.error('Signup error:', error);
                    if (error.message.includes('Email already exists')) {
                        showError('emailError', 'This email is already registered');
                    } else {
                        alert('Signup failed: ' + error.message);
                    }
                } finally {
                    signupButton.disabled = false;
                    signupButton.textContent = t['signup'];
                }
            }
        });
    }
    function showError(id, message) {
        const errorEl = document.getElementById(id);
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
    }

    // =============================================
    // LOGIN WITH BACKEND API INTEGRATION
    // =============================================
// Remove existing login button event listeners by cloning and replacing
const loginButton = document.querySelector('#login-form .auth-btn');
if (loginButton) {
    const newLoginButton = loginButton.cloneNode(true);
    loginButton.parentNode.replaceChild(newLoginButton, loginButton);
    
    // Now add the event listener to the new button
    newLoginButton.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Login button clicked - new listener');
        
        const phone = document.getElementById('loginPhone')?.value.trim();
        const password = document.getElementById('loginPassword')?.value.trim();
        const phonePattern = /^[6-9]\d{9}$/;
       
        if (phone && phonePattern.test(phone) && password) {
            try {
                // Store original state
                const originalText = newLoginButton.textContent;
                
                // Update button state
                newLoginButton.disabled = true;
                newLoginButton.textContent = 'Logging in...';
                newLoginButton.style.opacity = '0.7';
                
                // Use the updated login function
                const result = await loginUser(phone, password);
               
                if (result.success) {
                    console.log('Login successful:', result.user);
                    alert(`Welcome back, ${result.user.firstName}!`);
                   
                    // Safe form reset
                    const form = document.getElementById('login-form');
                    if (form && typeof form.reset === 'function') form.reset();
                    if (closeAuth) closeAuth.click();
                    updateLoginTrigger(result.user);
                } else {
                    alert(result.message || 'Invalid phone number or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            } finally {
                // Always re-enable the button
                newLoginButton.disabled = false;
                newLoginButton.style.opacity = '1';
                let currentLang = 'en';
                try {
                    currentLang = localStorage.getItem('language') || 'en';
                } catch (e) {}
                newLoginButton.textContent = translations[currentLang]['login'];
            }
        } else {
            console.warn('Invalid login input:', { phone, password });
            alert('Please enter a valid 10-digit phone number and password');
        }
    });
}
}

// =============================================
// APPLY LANGUAGE
// =============================================
function applyLanguage(lang) {
    console.log('Applying language:', lang);
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        } else {
            console.warn(`Translation missing for lang: ${lang}, key: ${key}`);
        }
    });
   
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[lang] && translations[lang][key]) {
            element.placeholder = translations[lang][key];
        } else {
            console.warn(`Placeholder translation missing for lang: ${lang}, key: ${key}`);
        }
    });
   
    const titleElement = document.querySelector('title');
    if (titleElement) {
        const titleKey = titleElement.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][titleKey]) {
            titleElement.textContent = translations[lang][titleKey];
        }
    }
  
    let savedPincode;
    try {
        savedPincode = localStorage.getItem('pincode');
    } catch (e) {
        savedPincode = null;
    }
  
    if (savedPincode) {
        const deliveryInfo = document.getElementById('deliveryInfo');
        const deliveryMessage = document.getElementById('deliveryMessage');
        const locationDisplay = document.getElementById('locationDisplay');
        if (locationDisplay) {
            locationDisplay.textContent = savedPincode;
        }
        const estimatedDays = savedPincode.startsWith('1') || savedPincode.startsWith('2') ? '2-3 days' : '3-5 days';
        if (deliveryInfo && deliveryMessage) {
            deliveryInfo.classList.remove('hidden');
            deliveryMessage.textContent = estimatedDays;
            deliveryMessage.classList.add('text-green-600');
        }
    }
}

// =============================================
// DOCUMENT READY
// =============================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded');
    initializePage();
});