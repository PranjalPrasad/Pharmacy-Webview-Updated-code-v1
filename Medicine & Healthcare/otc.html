<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTC Medicines – WhatsApp Order</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#36C2CE',
            secondary: '#0ea5e9',
            accent: '#10b981',
            dark: '#1e293b',
          }
        }
      }
    }
  </script>
  <style>
    .subcategory.hidden{display:none;}
    .product-card{transition:transform .2s ease,box-shadow .2s ease;border:1px solid #36C2CE !important;}
    .product-card:hover{transform:translateY(-5px);box-shadow:0 8px 16px rgba(0,0,0,.1);}
    .product-image{object-fit:contain;width:100%;height:160px;}
    .nav-sidebar{border:1px solid #36C2CE !important;}
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #36C2CE;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
    }
  </style>
</head>
<body class="bg-white">

<!-- Header -->
<header class="bg-white shadow-sm">
  <div class="container mx-auto px-4 py-3 flex justify-between items-center">
    <div class="flex items-center">
      <h1 class="text-xl font-bold text-primary">Pharmacy Store</h1>
    </div>
    <nav class="hidden md:flex space-x-6">
      <a href="#" class="text-gray-700 hover:text-primary">Home</a>
      <a href="#" class="text-gray-700 hover:text-primary">Categories</a>
      <a href="#" class="text-gray-700 hover:text-primary">Prescriptions</a>
      <a href="#" class="text-gray-700 hover:text-primary">Contact</a>
    </nav>
    <div class="flex items-center space-x-4">
      <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition">
        Login
      </button>
    </div>
  </div>
</header>

<!-- Hero -->
<section class="w-full h-48 relative bg-center bg-cover"
         style="background-image:url('https://i.pinimg.com/1200x/52/40/cf/5240cff0fb3479c7adc3351a22acc765.jpg');">
  <div class="absolute inset-0 bg-black/30"></div>
  <div class="relative z-10 flex items-center justify-center h-full">
    <h1 class="text-white text-2xl sm:text-3xl font-bold">Bloom with Confidence</h1>
  </div>
</section>

<div class="container mx-auto px-1 py-6">
  <div class="flex flex-col md:flex-row gap-6">

    <!-- Sidebar -->
    <aside class="w-full md:w-1/5 md:h-[calc(90vh-4rem)] md:sticky md:top-16 overflow-y-auto bg-white p-3 rounded-lg shadow nav-sidebar">
      <!-- Sort -->
      <div class="flex justify-start mb-6">
        <select id="sortSelect" class="w-52 border border-gray-300 p-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="relevance">Sort By: Relevance</option>
          <option value="price-low">Price: Low to High</option>
          <option value="price-high">Price: High to Low</option>
        </select>
      </div>

      <!-- Categories -->
      <h2 class="text-lg font-bold mb-2">Categories</h2>
      <ul id="categoryList" class="space-y-2">
        <li><a href="#" class="category-link font-medium" data-category="Pain Killers">Pain Killers</a></li>
        <li><a href="#" class="category-link font-medium" data-category="Infertility, OBS & Gynac">Infertility, OBS & Gynac</a></li>
        <li><a href="#" class="category-link font-medium" data-category="Cough Syrup">Cough Syrup</a></li>
        <li><a href="#" class="category-link font-medium" data-category="Antacids">Antacids</a></li>
        <li><a href="#" class="category-link font-medium" data-category="Wellness & Supplements">Wellness & Supplements</a></li>
        <li><a href="#" class="category-link font-medium" data-category="Anti-Infective">Anti-Infective</a></li>
        <li><a href="#" class="category-link font-medium" data-category="Laxative">Laxative</a></li>
        <li><a href="#" class="category-link font-medium" data-category="Flatulant">Flatulant</a></li>
      </ul>

      <!-- Brands -->
      <div class="mt-6">
        <h2 class="text-lg font-bold mb-2">Brands</h2>
        <ul id="brandList" class="space-y-2">
          <!-- Brands will be populated dynamically -->
        </ul>
      </div>
    </aside>

    <!-- Product Grid -->
    <section class="w-full md:w-5/6">
      <div id="loadingIndicator" class="hidden">
        <div class="loading-spinner"></div>
        <p class="text-center text-gray-600 mt-2">Loading products...</p>
      </div>
      
      <div id="errorMessage" class="hidden error-message">
        <p><strong>Connection Issue:</strong> Cannot connect to the server. Showing sample products instead.</p>
        <p class="text-sm mt-1">Make sure your Spring Boot server is running on localhost:8080</p>
      </div>
      
      <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- JS will fill this with products from API -->
      </div>
      
      <div id="noProductsMessage" class="hidden text-center py-8">
        <p class="text-gray-500 text-lg">No products found in this category.</p>
      </div>
    </section>

  </div>
</div>

<script>
/* ==============================================================
   API CONFIGURATION
   ============================================================== */
const API_BASE_URL = 'http://localhost:8080/api/products';

/* ==============================================================
   DOM & State
   ============================================================== */
const productGrid = document.getElementById('productGrid');
const categoryList = document.getElementById('categoryList');
const brandList = document.getElementById('brandList');
const sortSelect = document.getElementById('sortSelect');
const loadingIndicator = document.getElementById('loadingIndicator');
const noProductsMessage = document.getElementById('noProductsMessage');
const errorMessage = document.getElementById('errorMessage');

let products = [];
let activeCategory = null;
let activeSort = 'relevance';
let brands = new Set();

/* ==============================================================
   Helper Functions
   ============================================================== */
function escapeHtml(s) {
  if (!s) return '';
  return s.toString().replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
  }[m]));
}

function showLoading() {
  loadingIndicator.classList.remove('hidden');
  productGrid.classList.add('hidden');
  noProductsMessage.classList.add('hidden');
  errorMessage.classList.add('hidden');
}

function hideLoading() {
  loadingIndicator.classList.add('hidden');
}

function showNoProducts() {
  noProductsMessage.classList.remove('hidden');
  productGrid.classList.add('hidden');
}

function hideNoProducts() {
  noProductsMessage.classList.add('hidden');
}

function showError() {
  errorMessage.classList.remove('hidden');
  productGrid.classList.remove('hidden');
}

function hideError() {
  errorMessage.classList.add('hidden');
}

/* ==============================================================
   Sample OTC Products Data (Fallback)
   ============================================================== */
function getSampleOTCProducts() {
  return [
    {
      productId: 1,
      productName: "Tab. Crocin 500",
      productPrice: 35,
      originalPrice: 40,
      discount: "12% off",
      productCategory: "Pain Killers",
      brand: "Crocin",
      productMainImage: "https://via.placeholder.com/300x300/36C2CE/FFFFFF?text=Crocin+500",
      prescriptionRequired: false
    },
    {
      productId: 2,
      productName: "Tab. Calpol 650",
      productPrice: 45,
      originalPrice: null,
      discount: "",
      productCategory: "Pain Killers",
      brand: "Calpol",
      productMainImage: "https://via.placeholder.com/300x300/0ea5e9/FFFFFF?text=Calpol+650",
      prescriptionRequired: false
    },
    {
      productId: 3,
      productName: "Acekof Syrup",
      productPrice: 110,
      originalPrice: 130,
      discount: "15% off",
      productCategory: "Cough Syrup",
      brand: "Acekof",
      productMainImage: "https://via.placeholder.com/300x300/10b981/FFFFFF?text=Acekof+Syrup",
      prescriptionRequired: false
    },
    {
      productId: 4,
      productName: "Tab. Digene",
      productPrice: 85,
      originalPrice: 100,
      discount: "15% off",
      productCategory: "Antacids",
      brand: "Digene",
      productMainImage: "https://via.placeholder.com/300x300/8b5cf6/FFFFFF?text=Digene",
      prescriptionRequired: false
    },
    {
      productId: 5,
      productName: "Volini Spray",
      productPrice: 180,
      originalPrice: 210,
      discount: "14% off",
      productCategory: "Pain Killers",
      brand: "Volini",
      productMainImage: "https://via.placeholder.com/300x300/f59e0b/FFFFFF?text=Volini+Spray",
      prescriptionRequired: false
    },
    {
      productId: 6,
      productName: "Dettol Antiseptic",
      productPrice: 80,
      originalPrice: null,
      discount: "",
      productCategory: "Anti-Infective",
      brand: "Dettol",
      productMainImage: "https://via.placeholder.com/300x300/ef4444/FFFFFF?text=Dettol",
      prescriptionRequired: false
    },
    {
      productId: 7,
      productName: "Evion Capsules",
      productPrice: 95,
      originalPrice: null,
      discount: "",
      productCategory: "Wellness & Supplements",
      brand: "Evion",
      productMainImage: "https://via.placeholder.com/300x300/84cc16/FFFFFF?text=Evion+Capsules",
      prescriptionRequired: false
    },
    {
      productId: 8,
      productName: "Duphalac Syrup",
      productPrice: 210,
      originalPrice: 240,
      discount: "12% off",
      productCategory: "Laxative",
      brand: "Duphalac",
      productMainImage: "https://via.placeholder.com/300x300/06b6d4/FFFFFF?text=Duphalac+Syrup",
      prescriptionRequired: false
    }
  ];
}

/* ==============================================================
   API Functions
   ============================================================== */
async function fetchProductsBySubCategory(subCategory) {
  try {
    showLoading();
    console.log('Attempting to fetch products from:', `${API_BASE_URL}/get-category-by-subpath/${encodeURIComponent(subCategory)}`);
    
    const response = await fetch(`${API_BASE_URL}/get-category-by-subpath/${encodeURIComponent(subCategory)}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Successfully fetched products from API:', data);
    hideError();
    return data;
    
  } catch (error) {
    console.error('Error fetching products from API:', error);
    console.log('Falling back to sample data');
    showError();
    return getSampleOTCProducts();
  } finally {
    hideLoading();
  }
}

/* ==============================================================
   Product Card Creation
   ============================================================== */
function createProductCard(product) {
  const div = document.createElement('div');
  div.className = 'product-card bg-white p-4 shadow rounded-lg flex flex-col justify-between relative';

  const rxBadge = product.prescriptionRequired ? 
    `<div class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">Rx</div>` : '';

  const waMsg = encodeURIComponent(
    `Hi, I want to buy:\n*${product.productName}* – ₹${product.productPrice}\n${product.prescriptionRequired ? '(Prescription required)' : ''}`
  );

  div.innerHTML = `
    ${rxBadge}
    <img src="${product.productMainImage}" alt="${escapeHtml(product.productName)}" 
         class="product-image w-full h-32 rounded-lg mb-3"
         onerror="this.src='https://via.placeholder.com/300x300/cccccc/666666?text=Product+Image'">
    <p class="text-sm text-gray-600 font-medium">${escapeHtml(product.productName)}</p>
    <p class="text-xs text-gray-500">${escapeHtml(product.brand)}</p>
    ${product.prescriptionRequired ? '<p class="text-red-600 text-xs mt-1 font-semibold">Prescription needed</p>' : ''}
    <p class="text-green-600 font-bold mt-2">₹${product.productPrice.toFixed(2)}
      ${product.originalPrice ? 
        `<span class="text-gray-500 line-through text-sm">₹${product.originalPrice.toFixed(2)}</span> 
         <span class="text-green-600 text-sm">${escapeHtml(product.discount)}</span>` : ''}
    </p>
    <button class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition flex items-center justify-center gap-2 whatsapp-btn"
            data-product='${escapeHtml(JSON.stringify(product))}'>
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.52.149-.174.198-.298.297-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.262c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297C11.416.882 3.007 9.292 3.007 18.752c0 2.883.783 5.57 2.14 7.866l-2.24 6.48 6.62-2.18a11.95 11.95 0 005.561 1.39c6.614 0 12-5.387 12-12 0-3.204-1.238-6.217-3.486-8.486-2.248-2.27-5.26-3.524-8.486-3.524z"/>
      </svg>
      Order on WhatsApp
    </button>
  `;

  return div;
}

/* ==============================================================
   Rendering Functions
   ============================================================== */
function renderProducts(productList) {
  productGrid.innerHTML = '';
  
  if (productList.length === 0) {
    showNoProducts();
    return;
  }
  
  hideNoProducts();
  
  productList.forEach(product => {
    productGrid.appendChild(createProductCard(product));
  });
}

function updateBrandFilters() {
  brandList.innerHTML = '';
  
  if (brands.size === 0) {
    const noBrandsItem = document.createElement('li');
    noBrandsItem.textContent = 'No brands available';
    noBrandsItem.className = 'text-gray-500 text-sm';
    brandList.appendChild(noBrandsItem);
    return;
  }
  
  brands.forEach(brand => {
    const listItem = document.createElement('li');
    listItem.innerHTML = `
      <label class="flex items-center space-x-2 cursor-pointer">
        <input type="checkbox" class="brand-filter" value="${escapeHtml(brand)}">
        <span>${escapeHtml(brand)}</span>
      </label>
    `;
    brandList.appendChild(listItem);
  });
  
  // Add event listeners to new brand checkboxes
  document.querySelectorAll('.brand-filter').forEach(checkbox => {
    checkbox.addEventListener('change', applyFilters);
  });
}

/* ==============================================================
   Filtering and Sorting
   ============================================================== */
function applyFilters() {
  let filteredProducts = [...products];
  
  // Apply category filter
  if (activeCategory) {
    filteredProducts = filteredProducts.filter(p => p.productCategory === activeCategory);
  }
  
  // Apply brand filters
  const selectedBrands = Array.from(document.querySelectorAll('.brand-filter:checked'))
    .map(cb => cb.value);
  
  if (selectedBrands.length > 0) {
    filteredProducts = filteredProducts.filter(p => selectedBrands.includes(p.brand));
  }
  
  // Apply sorting
  if (activeSort === 'price-low') {
    filteredProducts.sort((a, b) => a.productPrice - b.productPrice);
  } else if (activeSort === 'price-high') {
    filteredProducts.sort((a, b) => b.productPrice - a.productPrice);
  }
  
  renderProducts(filteredProducts);
}

/* ==============================================================
   Event Listeners
   ============================================================== */
function setupEventListeners() {
  // Category selection
  categoryList.addEventListener('click', (e) => {
    if (e.target.classList.contains('category-link')) {
      e.preventDefault();
      const category = e.target.getAttribute('data-category');
      
      // Update active category
      activeCategory = category;
      
      // Update UI to show active category
      document.querySelectorAll('.category-link').forEach(link => {
        link.classList.remove('text-primary', 'font-bold');
      });
      e.target.classList.add('text-primary', 'font-bold');
      
      applyFilters();
    }
  });
  
  // Sort selection
  sortSelect.addEventListener('change', (e) => {
    activeSort = e.target.value;
    applyFilters();
  });
  
  // WhatsApp button delegation
  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('.whatsapp-btn');
    if (!btn) return;
    
    e.stopPropagation();
    const raw = btn.getAttribute('data-product');
    const product = JSON.parse(raw);
    const phone = '919876543210'; // Replace with your WhatsApp number
    const msg = encodeURIComponent(
      `Hi, I want to buy:\n*${product.productName}* – ₹${product.productPrice}\n${product.prescriptionRequired ? '(Prescription required)' : ''}`
    );
    window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
  });
}

/* ==============================================================
   Initialization
   ============================================================== */
async function initializePage() {
  // Setup event listeners first
  setupEventListeners();
  
  // Fetch OTC products from API
  console.log('Initializing page, fetching OTC products...');
  products = await fetchProductsBySubCategory('otc');
  
  // Extract unique brands from products
  products.forEach(product => {
    if (product.brand) {
      brands.add(product.brand);
    }
  });
  
  // Update brand filters
  updateBrandFilters();
  
  // Render all products initially
  renderProducts(products);
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', initializePage);
</script>

</body>
</html>